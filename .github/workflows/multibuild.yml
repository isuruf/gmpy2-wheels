name: Linux,macOS build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
        platform: [x64]
        PLAT: [arm64, x86_64, universal2]
        MB_PYTHON_VERSION: ['3.9']
    env:
      REPO_DIR: gmpy2
      MACOSX_DEPLOYMENT_TARGET: 10.9
      MB_PYTHON_VERSION: ${{ matrix.MB_PYTHON_VERSION }}
      TRAVIS_PYTHON_VERSION: ${{ matrix.MB_PYTHON_VERSION }}
      BUILD_DIR: ${{ github.workspace }}
      PLAT: ${{ matrix.PLAT }}
      BUILD_COMMIT: master

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Set extra env
      run: |
        if [[ "$(uname)" == "Darwin" ]]; then echo "TRAVIS_OS_NAME=osx" >> $GITHUB_ENV; else echo "TRAVIS_OS_NAME=${{ matrix.os }}" >> $GITHUB_ENV; fi
    - name: Print some Environment variable
      run: |
        echo "TRAVIS_OS_NAME: ${TRAVIS_OS_NAME}"
        echo "PLAT: ${PLAT}"
        ls -al /usr/local
    - name: Install VirtualEnv
      run: |
        python -m pip install --upgrade pip
        pip install virtualenv
    - name: Build and Install Wheels
      run: |
        sudo xcode-select -switch /Applications/Xcode_12.2.app
        export SDKROOT=/Applications/Xcode_12.2.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk
        set -x
        source multibuild/common_utils.sh
        source multibuild/travis_steps.sh
        echo "------ BEFORE BUILD ---------"
        before_install
        echo "------ CLEAN CODE --------"
        clean_code $REPO_DIR
        echo "------ BUILD WHEEL --------"
        build_wheel $REPO_DIR $PLAT
        echo "------ TEST WHEEL --------"
        if [[ "$PLAT" != "arm64" ]]; then
            install_run $PLAT
        fi
