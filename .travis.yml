env:
  global:
    - REPO_DIR=gmpy2
    - PLAT=x86_64
    - UNICODE_WIDTH=32

language: python
# The travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.5
sudo: required
dist: trusty
services: docker

matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.6
        - UPLOAD_SDIST=yes
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.6
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.3
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.3
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.4
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.4
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=2.7
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.4
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.5
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.6
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=pypy-5.7

before_install:
  - if [ ! -z ${TRAVIS_TAG} ]; then export BUILD_COMMIT=${TRAVIS_TAG}; fi
  - if [ -z ${TRAVIS_TAG} ]; then cd gmpy && git pull origin master && export BUILD_COMMIT=`git rev-parse HEAD` && cd ..; fi
  - source multibuild/common_utils.sh
  - source multibuild/travis_steps.sh
  - before_install

install:
  # Maybe get and clean and patch source
  - clean_code $REPO_DIR $BUILD_COMMIT
  - build_wheel $REPO_DIR $PLAT

script:
  - install_run $PLAT
  - if [ $UPLOAD_SDIST == "yes" ]; then cp archives/* wheelhouse/; fi

deploy:
  provider: releases
  api-key:
    secure: "POUaCfVaSlA7h5DuDkDVEqTWCd0+DtAWLeszBg84cEMM7ra7CzU2fWyKpnNezWt0AkfdwyIyo3VYct3YVArPiE/qBmmjrNioIl5rlgMW9VCr6WU5LJ1Y7v+zOGH+Qm9B/jhvD1arXyVaWZSnXhhjHDSlPi5DpIT90GS1OL+4sGl1Q9XokM55m60bf6m038Yy1E/OfO0oPilmwHs4RfMWAbjVewuAunQLmiNZYvFkgQAqsZUCyhQdph5LT5jN9Y0MoKmR8G3FOelXRunSRsrfo0giFSHzfBGr2uMz/h7Yr80UzFkEive/LTc5pCDKtGzSCPv60oUbHjKNVN207QJAToazQVgkFoE7E4EHOxfOaGfO2aH45haeQ/EZWwJDq0rrg2Fv48mhaZVx9eVRUCRu40U4SQuPa2uYNMrP07aBWf8IDgFG3UOYhU4EwWFlwcX1XELK5MWGwGveYfKFPARVqCVnKujOhuUNXYNJM/5pDjXxK0DASxacSiqybCeU2gOcdjj0Xf8ZBBfdzVtoAf2i6vHoihWZG8ywTkqve3QxQurhy6sFwoQJhy2VFJQjOPJrFEdwCHdKriqeygPi/sf5PZMW6Haz9XWcDhjeZ6vZsXJVF/AczdQD7p5hutGPOrlM3udur9pnfjrCgdYvL4/r3n7L71/9/7g5i+MZ58t8u38="
  file_glob: true
  file: wheelhouse/*
  skip_cleanup: true
  on:
    tags: true
